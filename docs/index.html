<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Lego NFT Avatars</title>
</head>
<body>


<script src="tutorial_libs/FileSaver.min.js"></script>
<script src="tutorial_libs/ora_file_b64.js"></script>
<!--<script src="dev_deps/jszip.min.js"></script>-->
<script src="dist/jsora.min.js"></script>
<script src="dist/lodash.min.js"></script>
<script>

    var config = { "Root": {} }
    var project = jsora.JSOra();

    async function initialize() {

        // example of loading and rendering an existing ORA file (At some url) to the page
        let loaded_file = await fetch(`img/AvatarImages.ora`).then(r => r.blob());
        await project.load(loaded_file);

        updateElementStates(true);

        renderAvatar();
    }

    // true == generating Avatar
    function updateElementStates(state)
    {
        if (state) {
        // remove any previous avatar canvases
            var oldCanvas = document.getElementById('avatar')
            oldCanvas === null ? false: oldCanvas.remove() ;

        }

        toggleButtonState(state)

    }

    async function renderAvatar() {

        const rend = new jsora.Renderer(project);

        // get config from project state
        getAvatarConfiguration(project);

        var rendered = await rend.make_merged_image(); // returns canvas
        rendered.id = "avatar"

        document.body.appendChild(rendered);

        console.log(config);
        
        updateElementStates(false)
    }

    function toggleButtonState(state)
    {
        if (state)
        {
            document.getElementById('btnGenerateAvatar').innerHTML = "Generating Avatar...";
            document.getElementById('btnGenerateAvatar').disabled = true;
        }
        else
        {
            document.getElementById('btnGenerateAvatar').innerHTML = "New Avatar";
            document.getElementById('btnGenerateAvatar').disabled = false;
        }
    }

    function addToConfig(partString) {
            var objectToAdd = recursivelyCreateNodes(partString.split(".").reverse());
            config = _.merge(config, objectToAdd);
        }

    function recursivelyCreateNodes(partArray) {
        if (partArray.length <= 1)
        {
            return partArray[0];
        }
        else 
        {
            var node = {};
            var nodeName = partArray.pop();
            node[nodeName] = recursivelyCreateNodes(partArray);
            return node;
        }
    }

    function recurseOverChildren(obj, parent) {
        for (let child of obj.children) {

            if (child.children != undefined) {
                recurseOverChildren(child, parent + "." + child.name)
            } else {
            if (!child.hidden)
                {
                    addToConfig(parent + "." + child.name);
                }
            }                
        }
    }    

    async function getAvatarConfiguration(project)
    {
 
        // extract avatar format from layers
        recurseOverChildren(project, "Root");

        return config
    }    

    function getRandomConfig() {
        // TODO: we assume some layer properties here.
        // we should encode whether part is nullable on layer name
    }

    function generateAvatar() {

        // generate new image from newConfig
        updateElementStates(true);

        // create a new random config
        getRandomConfig();


        renderAvatar();
    }

    initialize();

</script>


</body>
<p>
    <button id="btnGenerateAvatar" disabled type="button" onclick=generateAvatar()>
        Generating Avatar...
    </button>
</p>

</html>